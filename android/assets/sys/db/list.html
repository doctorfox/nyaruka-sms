{! extends "base.html" !}

{! block actions !}
<ul class="secondary-nav">
  <li class="dropdown"> 
    <a href="#" class="dropdown-toggle">Actions</a> 
    <ul class="dropdown-menu">
      <li><a href="#" id="add_button">Add Record</a></li>
      <li><a href="#" id="delete_button">Delete Collection</a></li>
    </ul>
  </li> 
</ul>
{! endblock !}

{! block content !}
<div class="page-header">
  <h1>{{ collection.name }}</h1>
</div>

<table class="zebra-striped">
  <thead>
    <tr>
      <th width="40">id</th>
      {% for key in keys %}
      <th>{{ key }}</th>
      {% endfor %}
    </tr>
  </thead>

  <tbody>
    {% for record in records %}
    <tr class="record_row {% cycle 'row1','row2' %}" record_id="{{ record.id }}">
      <td>{{ record.id }}</td>
      {% for key in keys %}
      <td>{{ record|get:key }}</td>
      {% endfor %}
    </tr>
    {% endfor %}
  </tbody>
</table>

<form id="delete_form" method="POST" action="/db/{{collection.name}}/delete/">
</form>
{! endblock !}

{! block extrascript !}
<script>
  $(document).ready(function(){
  
    $(".record_row").click(function(){
      document.location.href = "/db/{{collection.name}}/" + $(this).attr("record_id") + "/";
    });

    $("#add_button").click(function(event){
      event.preventDefault(); 
      showEditor("Add Record");
    });

    $("#delete_button").click(function(event){
      if (confirm("Remove collection?")){
        $("#delete_form").submit();
      }
      event.preventDefault();
    });
  });
  

var editor = null;

function showEditor(title){
  $("#editor_title").text(title);

  $("#mask").css({ width: $(window).width(), height: $(window).height() });
  $("#mask").show();
  $("#editor_window").show();

  if (!editor){
    var opts = { indent_size: 1, indent_char: '\t' };
    res = js_beautify($("#editor").text(), opts)
    $("#editor").text(res);

    editor = ace.edit("editor");
    editor.setShowPrintMargin(false);
    var JSONMode = require("ace/mode/json").Mode;
    editor.getSession().setMode(new JSONMode());

    var text = editor.getSession().getValue();
    if (text.length == 0){
      editor.getSession().setValue("{\n\n}");
      editor.gotoLine(2);
    }
    editor.focus();
  }
}

$(document).ready(function(){
  $("#mask").click(function(){
    $("#mask").hide();
    $("#editor_window").hide();
  });

  $("#cancel_button").click(function(event){
    event.preventDefault();
    $("#mask").hide();
    $("#editor_window").hide();
  });

  $("#save_button").click(function(event){
    try {
      // this will throw if their json is invalid
      JSON.parse(editor.getSession().getValue());
      $("#json").val(editor.getSession().getValue());
      $("#form").submit();
    } catch(e) {
      // warn them if so
      alert("Your JSON contains a syntax error, please try again.");
      editor.focus();
    }
    event.preventDefault(); 
  });
});
  
  
</script>
{! endblock !}
